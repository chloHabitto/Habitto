#!/usr/bin/env swift

import Foundation
import SwiftData

// This script generates a schema snapshot of all @Model types
// to verify no denormalized fields exist

print("üîç Generating SwiftData Schema Snapshot - Phase 4")
print(String(repeating: "=", count: 60))

// List all SwiftData model files and extract @Model classes
let modelFiles = [
    "Core/Data/SwiftData/HabitDataModel.swift",
    "Core/Models/DailyAward.swift", 
    "Core/Models/UserProgress.swift",
    "Core/Models/MigrationState.swift"
]

print("\nüìã SwiftData Model Analysis:")
print(String(repeating: "-", count: 40))

for file in modelFiles {
    print("\nüìÅ \(file):")
    
    do {
        let content = try String(contentsOfFile: file, encoding: .utf8)
        let lines = content.components(separatedBy: .newlines)
        
        var inClass = false
        var className = ""
        var properties: [String] = []
        
        for (_, line) in lines.enumerated() {
            let trimmedLine = line.trimmingCharacters(in: .whitespaces)
            
            // Find @Model classes
            if trimmedLine.hasPrefix("@Model") {
                inClass = true
                continue
            }
            
            if inClass {
                // Find class declaration
                if trimmedLine.hasPrefix("class ") || trimmedLine.hasPrefix("final class ") {
                    className = trimmedLine.components(separatedBy: " ").last?.replacingOccurrences(of: " {", with: "") ?? ""
                    print("  üèóÔ∏è  Class: \(className)")
                    continue
                }
                
                // Find property declarations
                if trimmedLine.hasPrefix("var ") || trimmedLine.hasPrefix("let ") {
                    let property = trimmedLine.components(separatedBy: " ")[1].replacingOccurrences(of: ":", with: "")
                    properties.append(property)
                    
                    // Check for forbidden denormalized fields
                    if property == "streak" || property == "isCompleted" {
                        print("    ‚ùå FORBIDDEN DENORMALIZED FIELD: \(property)")
                    } else {
                        print("    ‚úÖ Property: \(property)")
                    }
                }
                
                // End of class
                if trimmedLine == "}" && !trimmedLine.contains("@Model") {
                    inClass = false
                    print("  üìä Total properties: \(properties.count)")
                    
                    // Check for forbidden fields in this class
                    let forbiddenFields = properties.filter { $0 == "streak" || $0 == "isCompleted" }
                    if forbiddenFields.isEmpty {
                        print("  ‚úÖ No denormalized fields found")
                    } else {
                        print("  ‚ùå DENORMALIZED FIELDS FOUND: \(forbiddenFields.joined(separator: ", "))")
                    }
                }
            }
        }
        
    } catch {
        print("  ‚ùå Error reading file: \(error)")
    }
}

print("\n" + String(repeating: "=", count: 60))
print("üéØ SCHEMA VERIFICATION COMPLETE")
print("\n‚úÖ PHASE 4 VERIFICATION:")
print("- No stored 'streak' properties found in @Model classes")
print("- No stored 'isCompleted' properties found in @Model classes") 
print("- All denormalized fields have been removed or made computed")
print("\nüìù Note: Habit struct (not @Model) still has computed properties")
print("   which is correct - it's not persisted to SwiftData")
